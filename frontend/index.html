<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Translator Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        /* Animated background particles */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .particle {
            position: absolute;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .header h1 {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .upload-card, .video-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .upload-card:hover, .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 35px 70px rgba(0, 0, 0, 0.4);
        }

        .upload-section {
            padding: 2rem;
        }

        .upload-area {
            border: 3px dashed rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: scale(1.02);
        }

        .upload-area:hover::before {
            opacity: 1;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            transform: scale(1.05);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .video-container {
            padding: 2rem;
            text-align: center;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            margin: 0 auto;
        }

        .video-player {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
        }

        /* FIXED: Improved subtitle styling with proper responsive sizing */
        .subtitle-overlay {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            max-width: 85%;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
            line-height: 1.3;
            word-break: break-word;
            white-space: normal;
            text-shadow: 1px 1px 2px black;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            
            /* FIXED: Base font size using viewport units for better scaling */
            font-size: min(2.5vw, 14px);
        }

        .subtitle-overlay.show {
            opacity: 1;
        }

        .subtitle-overlay.multiline {
            white-space: normal;
            padding: 8px 14px;
            line-height: 1.4;
        }

        .subtitle-overlay.top {
            bottom: auto;
            top: 10%;
        }

        .subtitle-overlay.center {
            bottom: auto;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
        }

        /* FIXED: Better fullscreen detection and sizing */
        .video-wrapper:-webkit-full-screen .subtitle-overlay,
        .video-wrapper:-moz-full-screen .subtitle-overlay,
        .video-wrapper:fullscreen .subtitle-overlay,
        .subtitle-overlay.fullscreen-active {
            font-size: min(3vw, 24px) !important;
            padding: 10px 18px !important;
            border-radius: 6px !important;
            max-width: 80% !important;
            bottom: 8% !important;
        }

        /* FIXED: Media queries for better responsive behavior */
        @media (max-width: 480px) {
            .subtitle-overlay {
                font-size: min(3.5vw, 12px);
                padding: 4px 8px;
                max-width: 90%;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .subtitle-overlay {
                font-size: min(2.8vw, 13px);
                padding: 5px 10px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .subtitle-overlay {
                font-size: min(2.2vw, 15px);
                padding: 6px 12px;
            }
        }

        @media (min-width: 1025px) {
            .subtitle-overlay {
                font-size: min(1.8vw, 16px);
                padding: 7px 14px;
            }
        }

        /* FIXED: Ensure subtitles work in all fullscreen modes */
        .video-wrapper:-webkit-full-screen,
        .video-wrapper:-moz-full-screen,
        .video-wrapper:fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            border-radius: 0 !important;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-control {
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .form-control option {
            background: #1a1a2e;
            color: white;
        }

        .btn {
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.3s ease;
            animation: progressShine 2s linear infinite;
        }

        @keyframes progressShine {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .status {
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
            backdrop-filter: blur(10px);
        }

        .status.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status.loading {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-section {
            margin-top: 2rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }

        .result-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
        }

        .result-content {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .file-info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
        }

        .file-info h4 {
            margin-bottom: 0.5rem;
            color: #667eea;
        }

        .subtitle-controls {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .subtitle-toggle {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.5);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .subtitle-toggle:hover {
            background: rgba(102, 126, 234, 0.4);
        }

        .subtitle-toggle.active {
            background: rgba(102, 126, 234, 0.6);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.4);
        }

        /* Debug info */
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Debug info -->
    <div class="debug-info" id="debugInfo"></div>

    <!-- Animated background particles -->
    <div class="bg-particles"></div>

    <div class="container">
        <div class="header">
            <h1>🎬 AI Video Translator Pro</h1>
            <p>Advanced AI-powered video translation with real-time subtitle overlay</p>
        </div>

        <div class="main-grid">
            <!-- Upload Section -->
            <div class="upload-card">
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <span class="upload-icon">🎬</span>
                        <div class="upload-text" style="font-size: 1.2rem; margin-bottom: 0.5rem;">Drop your video here or click to browse</div>
                        <div class="upload-subtext" style="opacity: 0.7;">Supports MP4, MOV, MKV, AVI formats</div>
                        <input type="file" id="fileInput" class="file-input" accept=".mp4,.mov,.mkv,.avi" style="display: none;">
                    </div>
                    <div id="fileInfo" class="file-info" style="display: none;">
                        <h4>📁 File Information</h4>
                        <div id="fileDetails"></div>
                    </div>
                </div>
            </div>

            <!-- Video Preview Section -->
            <div class="video-card">
                <div class="video-container" id="videoContainer">
                    <div style="opacity: 0.5; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📺</div>
                        <h3>Video Preview</h3>
                        <p>Upload a video to see the preview with live subtitles</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="controls">
                <div class="form-group">
                    <label for="sourceLanguage">Source Language</label>
                    <select id="sourceLanguage" class="form-control">
                        <option value="">Auto-detect</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="zh">Chinese</option>
                        <option value="ja">Japanese</option>
                        <option value="ar">Arabic</option>
                        <option value="ru">Russian</option>
                        <option value="hi">Hindi</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="targetLanguage">Target Language</label>
                    <select id="targetLanguage" class="form-control">
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="ar">Arabic</option>
                        <option value="zh">Chinese</option>
                        <option value="ja">Japanese</option>
                        <option value="en">English</option>
                        <option value="hi">Hindi</option>
                        <option value="ru">Russian</option>
                        <option value="pt">Portuguese</option>
                        <option value="ko">Korean</option>
                        <option value="it">Italian</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subtitleStyle">Subtitle Position</label>
                    <select id="subtitleStyle" class="form-control">
                        <option value="bottom">Bottom (YouTube Style)</option>
                        <option value="top">Top Overlay</option>
                        <option value="center">Center Overlay</option>
                    </select>
                </div>
            </div>

            <div class="action-buttons">
                <button id="processBtn" class="btn btn-primary" disabled>
                    <span id="processText">🚀 Start Translation</span>
                </button>
                <button id="resetBtn" class="btn btn-secondary" style="display: none;">
                    🔄 Reset
                </button>
                <button id="demoBtn" class="btn btn-secondary">
                    🧪 Load Demo
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="progress-section" style="display: none;">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="statusMessage" class="status loading">
                <span class="loading-spinner"></span>
                Initializing...
            </div>
        </div>

        <!-- Results Section -->
        <div id="transcriptSection" class="result-section" style="display: none;">
            <div class="result-title">
                📝 Original Transcript
            </div>
            <div id="transcriptResult" class="result-content"></div>
        </div>

        <div id="translationSection" class="result-section" style="display: none;">
            <div class="result-title">
                🌍 Translation Result
            </div>
            <div id="translationResult" class="result-content"></div>
            <div class="subtitle-controls">
                <button id="enableSubtitlesBtn" class="subtitle-toggle">Enable Live Subtitles</button>
                <button id="disableSubtitlesBtn" class="subtitle-toggle">Disable Subtitles</button>
                <button id="downloadSubtitlesBtn" class="subtitle-toggle">Download SRT</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentFile = null;
        let currentFilename = null;
        let videoElement = null;
        let subtitleElement = null;
        let translatedSegments = [];
        let originalTranscript = '';
        let subtitlesEnabled = false;
        let debugMode = false;
        let isFullscreen = false;

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileDetails = document.getElementById('fileDetails');
        const videoContainer = document.getElementById('videoContainer');
        const processBtn = document.getElementById('processBtn');
        const resetBtn = document.getElementById('resetBtn');
        const demoBtn = document.getElementById('demoBtn');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const statusMessage = document.getElementById('statusMessage');
        const transcriptSection = document.getElementById('transcriptSection');
        const translationSection = document.getElementById('translationSection');
        const transcriptResult = document.getElementById('transcriptResult');
        const translationResult = document.getElementById('translationResult');
        const processText = document.getElementById('processText');
        const enableSubtitlesBtn = document.getElementById('enableSubtitlesBtn');
        const disableSubtitlesBtn = document.getElementById('disableSubtitlesBtn');
        const downloadSubtitlesBtn = document.getElementById('downloadSubtitlesBtn');
        const debugInfo = document.getElementById('debugInfo');

        // Initialize animated background
        createParticles();

        // File upload handling
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        function createParticles() {
            const particlesContainer = document.querySelector('.bg-particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.width = Math.random() * 6 + 2 + 'px';
                particle.style.height = particle.style.width;
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            currentFile = file;
            
            // Update upload area
            uploadArea.innerHTML = `
                <span class="upload-icon" style="color: #10b981;">✅</span>
                <div class="upload-text" style="color: #10b981;">File Ready: ${file.name}</div>
                <div class="upload-subtext">Click "Start Translation" to begin processing</div>
            `;
            
            // Show file info
            fileDetails.innerHTML = `
                <strong>Name:</strong> ${file.name}<br>
                <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                <strong>Type:</strong> ${file.type}<br>
                <strong>Status:</strong> Ready for processing
            `;
            fileInfo.style.display = 'block';
            
            // Create video preview
            createVideoPreview(file);
            
            processBtn.disabled = false;
        }

        function createVideoPreview(file) {
            const videoURL = URL.createObjectURL(file);
            
            videoContainer.innerHTML = `
                <div class="video-wrapper">
                    <video class="video-player" id="videoPlayer" controls>
                        <source src="${videoURL}" type="${file.type}">
                        Your browser does not support the video tag.
                    </video>
                    <div class="subtitle-overlay" id="subtitleOverlay"></div>
                </div>
                <p style="margin-top: 1rem; opacity: 0.8;">🎯 Ready for AI translation</p>
            `;
            
            videoElement = document.getElementById('videoPlayer');
            subtitleElement = document.getElementById('subtitleOverlay');
            
            // Reset subtitle state
            subtitlesEnabled = false;
            if (subtitleElement) {
                subtitleElement.classList.remove('show');
            }
            
            // FIXED: Add improved event listeners for fullscreen detection
            if (videoElement) {
                videoElement.addEventListener('timeupdate', updateSubtitles);
                videoElement.addEventListener('seeked', updateSubtitles);
                videoElement.addEventListener('play', () => {
                    if (subtitlesEnabled) updateSubtitles();
                });
                
                // FIXED: Better fullscreen detection using multiple methods
                setupFullscreenListeners();
            }
        }

        // FIXED: Improved fullscreen detection and handling
        function setupFullscreenListeners() {
            // Multiple event listeners for cross-browser compatibility
            const events = ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'msfullscreenchange'];
            
            events.forEach(event => {
                document.addEventListener(event, handleFullscreenChange, false);
            });
            
            // Also check for video-specific fullscreen events
            if (videoElement) {
                videoElement.addEventListener('webkitbeginfullscreen', () => {
                    isFullscreen = true;
                    updateFullscreenSubtitles();
                });
                
                videoElement.addEventListener('webkitendfullscreen', () => {
                    isFullscreen = false;
                    updateFullscreenSubtitles();
                });
            }
            
            // Fallback: periodically check fullscreen state
            setInterval(checkFullscreenState, 500);
        }

        function checkFullscreenState() {
            const currentFullscreenState = !!(
                document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement ||
                (videoElement && videoElement.webkitDisplayingFullscreen)
            );
            
            if (currentFullscreenState !== isFullscreen) {
                isFullscreen = currentFullscreenState;
                updateFullscreenSubtitles();
                
                if (debugMode) {
                    console.log('Fullscreen state changed:', isFullscreen);
                }
            }
        }

        function handleFullscreenChange() {
            checkFullscreenState();
        }

        function updateFullscreenSubtitles() {
            if (subtitleElement) {
                if (isFullscreen) {
                    subtitleElement.classList.add('fullscreen-active');
                } else {
                    subtitleElement.classList.remove('fullscreen-active');
                }
                
                // Force subtitle position update
                updateSubtitlePosition();
                
                // Force subtitle update if currently playing
                if (subtitlesEnabled) {
                    setTimeout(updateSubtitles, 100); // Small delay to ensure DOM updates
                }
            }
        }

        function updateSubtitles() {
            if (!subtitlesEnabled || !translatedSegments || !videoElement || !subtitleElement) {
                if (debugMode) {
                    debugInfo.innerHTML = `
                        Status: Not ready<br>
                        Subtitles Enabled: ${subtitlesEnabled}<br>
                        Segments: ${translatedSegments ? translatedSegments.length : 0}<br>
                        Video Element: ${!!videoElement}<br>
                        Subtitle Element: ${!!subtitleElement}<br>
                        Fullscreen: ${isFullscreen}
                    `;
                    debugInfo.style.display = 'block';
                }
                return;
            }

            const currentTime = videoElement.currentTime;
            let activeSubtitle = null;

            // Find the current subtitle segment
            for (const segment of translatedSegments) {
                if (currentTime >= segment.start && currentTime <= segment.end) {
                    activeSubtitle = segment.text;
                    break;
                }
            }

            if (debugMode) {
                debugInfo.innerHTML = `
                    Current Time: ${currentTime.toFixed(2)}s<br>
                    Active Subtitle: ${activeSubtitle ? 'Yes' : 'No'}<br>
                    Segments: ${translatedSegments.length}<br>
                    Fullscreen: ${isFullscreen}<br>
                    Element Visible: ${subtitleElement.classList.contains('show')}<br>
                    Font Size: ${window.getComputedStyle(subtitleElement).fontSize}
                `;
                debugInfo.style.display = 'block';
            }

            // Update subtitle display
            if (activeSubtitle) {
                // Clean and format the subtitle text
                const cleanText = activeSubtitle.trim();
                
                // FIXED: Better line breaking logic based on screen size
                const maxLineLength = isFullscreen ? 80 : (window.innerWidth < 768 ? 30 : 50);
                const needsMultiline = cleanText.length > maxLineLength || cleanText.includes('\n');
                
                if (needsMultiline) {
                    subtitleElement.classList.add('multiline');
                    
                    // Smart line breaking for long text
                    const words = cleanText.split(' ');
                    let lines = [];
                    let currentLine = '';
                    
                    words.forEach(word => {
                        if ((currentLine + word).length <= maxLineLength) {
                            currentLine += (currentLine ? ' ' : '') + word;
                        } else {
                            if (currentLine) lines.push(currentLine);
                            currentLine = word;
                        }
                    });
                    
                    if (currentLine) lines.push(currentLine);
                    
                    // Limit to maximum 3 lines for readability
                    if (lines.length > 3) {
                        lines = lines.slice(0, 2);
                        lines[1] += '...';
                    }
                    
                    subtitleElement.innerHTML = lines.join('<br>');
                } else {
                    subtitleElement.classList.remove('multiline');
                    subtitleElement.textContent = cleanText;
                }
                
                subtitleElement.classList.add('show');
            } else {
                subtitleElement.classList.remove('show');
            }
        }

        function updateSubtitlePosition() {
            if (!subtitleElement) return;
            
            const style = document.getElementById('subtitleStyle').value;
            subtitleElement.classList.remove('top', 'center');
            
            if (style === 'top') {
                subtitleElement.classList.add('top');
            } else if (style === 'center') {
                subtitleElement.classList.add('center');
            }
            
            // Ensure fullscreen class is maintained
            if (isFullscreen) {
                subtitleElement.classList.add('fullscreen-active');
            } else {
                subtitleElement.classList.remove('fullscreen-active');
            }
        }

        // Process button
        processBtn.addEventListener('click', async () => {
            if (!currentFile) return;

            try {
                showProgress();
                await uploadAndProcess();
            } catch (error) {
                showError('Processing failed: ' + error.message);
            }
        });

        // Reset button
        resetBtn.addEventListener('click', () => {
            currentFile = null;
            currentFilename = null;
            translatedSegments = [];
            originalTranscript = '';
            subtitlesEnabled = false;
            isFullscreen = false;
            fileInput.value = '';
            
            // Remove fullscreen event listeners
            const events = ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'msfullscreenchange'];
            events.forEach(event => {
                document.removeEventListener(event, handleFullscreenChange, false);
            });
            
            // Reset upload area
            uploadArea.innerHTML = `
                <span class="upload-icon">🎬</span>
                <div class="upload-text" style="font-size: 1.2rem; margin-bottom: 0.5rem;">Drop your video here or click to browse</div>
                <div class="upload-subtext" style="opacity: 0.7;">Supports MP4, MOV, MKV, AVI formats</div>
            `;
            
            // Reset video container
            videoContainer.innerHTML = `
                <div style="opacity: 0.5; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📺</div>
                    <h3>Video Preview</h3>
                    <p>Upload a video to see the preview with live subtitles</p>
                </div>
            `;
            
            processBtn.disabled = true;
            fileInfo.style.display = 'none';
            hideProgress();
            transcriptSection.style.display = 'none';
            translationSection.style.display = 'none';
            resetBtn.style.display = 'none';
            debugInfo.style.display = 'none';
        });

        // Demo button for testing
        demoBtn.addEventListener('click', () => {
            const demo = loadDemoData();
            originalTranscript = demo.transcript;
            translatedSegments = demo.segments;
            
            transcriptResult.textContent = originalTranscript;
            translationResult.textContent = demo.translation;
            transcriptSection.style.display = 'block';
            translationSection.style.display = 'block';
            resetBtn.style.display = 'inline-block';
            
            // Create demo video with proper subtitle overlay
            createDemoVideo();
            
            // Auto-enable subtitles after short delay
            setTimeout(() => {
                subtitlesEnabled = true;
                enableSubtitlesBtn.classList.add('active');
                disableSubtitlesBtn.classList.remove('active');
                updateSubtitlePosition();
                console.log('Demo subtitles enabled with', translatedSegments.length, 'segments');
            }, 1000);
        });

        // Subtitle control buttons
        enableSubtitlesBtn.addEventListener('click', () => {
            if (translatedSegments && translatedSegments.length > 0) {
                subtitlesEnabled = true;
                enableSubtitlesBtn.classList.add('active');
                disableSubtitlesBtn.classList.remove('active');
                updateSubtitles(); // Force update
                console.log('Subtitles enabled');
            } else {
                alert('Please complete translation first to enable subtitles');
            }
        });

        disableSubtitlesBtn.addEventListener('click', () => {
            subtitlesEnabled = false;
            if (subtitleElement) {
                subtitleElement.classList.remove('show');
            }
            disableSubtitlesBtn.classList.add('active');
            enableSubtitlesBtn.classList.remove('active');
            console.log('Subtitles disabled');
        });

        downloadSubtitlesBtn.addEventListener('click', () => {
            if (translatedSegments.length > 0) {
                downloadSRT();
            } else {
                alert('No translated subtitles available for download');
            }
        });

        // Listen for subtitle style changes
        document.getElementById('subtitleStyle').addEventListener('change', (e) => {
            if (subtitlesEnabled && subtitleElement) {
                updateSubtitlePosition();
            }
        });

        // Debug mode toggle (double-click header)
        document.querySelector('.header h1').addEventListener('dblclick', () => {
            debugMode = !debugMode;
            if (!debugMode) {
                debugInfo.style.display = 'none';
            }
            console.log('Debug mode:', debugMode);
        });

        // FIXED: Add window resize listener to update subtitle sizing
        window.addEventListener('resize', () => {
            if (subtitlesEnabled && subtitleElement) {
                // Small delay to ensure window dimensions are updated
                setTimeout(() => {
                    updateSubtitles();
                }, 100);
            }
        });

        async function uploadAndProcess() {
            try {
                // Step 1: Upload
                updateProgress(20, 'Uploading video...');
                
                const uploadData = new FormData();
                uploadData.append('file', currentFile);

                const uploadResponse = await fetch(`${API_BASE}/upload/`, {
                    method: 'POST',
                    body: uploadData
                });

                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }

                const uploadResult = await uploadResponse.json();
                currentFilename = uploadResult.filename;

                // Step 2: Transcribe
                updateProgress(50, 'Transcribing audio...');
                
                const transcribeData = new FormData();
                transcribeData.append('filename', currentFilename);
                const sourceLang = document.getElementById('sourceLanguage').value;
                if (sourceLang) {
                    transcribeData.append('lang', sourceLang);
                }

                const transcribeResponse = await fetch(`${API_BASE}/transcribe/`, {
                    method: 'POST',
                    body: transcribeData
                });

                if (!transcribeResponse.ok) {
                    throw new Error('Transcription failed');
                }

                const transcribeResult = await transcribeResponse.json();
                
                if (transcribeResult.error) {
                    throw new Error(transcribeResult.error);
                }

                originalTranscript = transcribeResult.transcript;
                const originalSegments = transcribeResult.segments;
                
                // Show transcript
                transcriptResult.textContent = originalTranscript;
                transcriptSection.style.display = 'block';
                transcriptSection.style.animation = 'fadeInUp 0.5s ease';

                // Step 3: Translate
                updateProgress(80, 'Translating text...');
                
                const translateData = new FormData();
                translateData.append('transcript', originalTranscript);
                translateData.append('target_lang', document.getElementById('targetLanguage').value);
                translateData.append('segments', JSON.stringify(originalSegments));

                const translateResponse = await fetch(`${API_BASE}/translate/`, {
                    method: 'POST',
                    body: translateData
                });

                if (!translateResponse.ok) {
                    throw new Error('Translation failed');
                }

                const translateResult = await translateResponse.json();
                
                if (translateResult.error) {
                    throw new Error(translateResult.error);
                }

                const translatedText = translateResult.translated_text;
                translatedSegments = translateResult.translated_segments || [];
                
                // Show translation
                translationResult.textContent = translatedText;
                translationSection.style.display = 'block';
                translationSection.style.animation = 'fadeInUp 0.7s ease';

                // Final step
                updateProgress(100, 'Complete! 🎉');
                
                setTimeout(() => {
                    hideProgress();
                    resetBtn.style.display = 'inline-block';
                    
                    // Auto-enable subtitles if we have segments
                    if (translatedSegments.length > 0) {
                        subtitlesEnabled = true;
                        enableSubtitlesBtn.classList.add('active');
                        updateSubtitlePosition();
                        console.log('Auto-enabled subtitles with', translatedSegments.length, 'segments');
                    }
                }, 2000);

            } catch (error) {
                console.error('Processing error:', error);
                showError(error.message);
            }
        }

        function createDemoVideo() {
            // Create a simple canvas-based demo video that loops
            videoContainer.innerHTML = `
                <div class="video-wrapper">
                    <canvas id="demoCanvas" width="640" height="360" style="width: 100%; height: auto; background: linear-gradient(45deg, #667eea, #764ba2); border-radius: 10px; cursor: pointer;"></canvas>
                    <div class="subtitle-overlay" id="subtitleOverlay"></div>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); pointer-events: none;">
                        ▶ Click to Start Demo
                    </div>
                    <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px;">
                        <span id="demoTime">0:00</span> / 20:00
                    </div>
                </div>
                <p style="margin-top: 1rem; opacity: 0.8;">🎯 Demo loaded - Click video to start, then enable subtitles!</p>
            `;
            
            // Set up demo video simulation
            const canvas = document.getElementById('demoCanvas');
            const demoTimeDisplay = document.getElementById('demoTime');
            subtitleElement = document.getElementById('subtitleOverlay');
            
            let demoTime = 0;
            let isPlaying = false;
            let demoInterval = null;
            
            // Create mock video element for subtitle system
            videoElement = {
                currentTime: 0,
                duration: 20,
                paused: true,
                addEventListener: function(event, callback) {
                    if (event === 'timeupdate') {
                        this.timeUpdateCallback = callback;
                    }
                },
                play: function() {
                    this.paused = false;
                    isPlaying = true;
                    startDemo();
                },
                pause: function() {
                    this.paused = true;
                    isPlaying = false;
                    if (demoInterval) {
                        clearInterval(demoInterval);
                        demoInterval = null;
                    }
                }
            };
            
            function startDemo() {
                if (demoInterval) clearInterval(demoInterval);
                
                demoInterval = setInterval(() => {
                    if (isPlaying) {
                        demoTime += 0.1;
                        if (demoTime >= 20) {
                            demoTime = 0; // Loop
                        }
                        
                        videoElement.currentTime = demoTime;
                        
                        // Update time display
                        const minutes = Math.floor(demoTime / 60);
                        const seconds = Math.floor(demoTime % 60);
                        demoTimeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Trigger subtitle update
                        if (videoElement.timeUpdateCallback) {
                            videoElement.timeUpdateCallback();
                        }
                    }
                }, 100); // Update every 100ms for smooth subtitle timing
            }
            
            // Click to play/pause
            canvas.addEventListener('click', () => {
                if (isPlaying) {
                    videoElement.pause();
                    canvas.nextElementSibling.textContent = '▶ Click to Resume';
                } else {
                    videoElement.play();
                    canvas.nextElementSibling.textContent = '⏸ Click to Pause';
                }
            });
            
            // Setup fullscreen listeners for demo as well
            setupFullscreenListeners();
            
            console.log('Demo video simulation created');
        }

        function showProgress() {
            progressSection.style.display = 'block';
            processBtn.disabled = true;
            processText.innerHTML = '<span class="loading-spinner"></span>Processing...';
        }

        function hideProgress() {
            progressSection.style.display = 'none';
            processBtn.disabled = false;
            processText.innerHTML = '🚀 Start Translation';
        }

        function updateProgress(percent, message) {
            progressFill.style.width = percent + '%';
            statusMessage.innerHTML = `<span class="loading-spinner"></span>${message}`;
            statusMessage.className = 'status loading';
        }

        function showError(message) {
            statusMessage.className = 'status error';
            statusMessage.textContent = '❌ ' + message;
            processBtn.disabled = false;
            processText.innerHTML = '🚀 Start Translation';
        }

        function downloadSRT() {
            if (translatedSegments.length === 0) return;

            // Generate SRT content
            let srtContent = '';
            translatedSegments.forEach((segment, index) => {
                const startTime = formatSRTTime(segment.start);
                const endTime = formatSRTTime(segment.end);
                
                srtContent += `${index + 1}\n`;
                srtContent += `${startTime} --> ${endTime}\n`;
                srtContent += `${segment.text}\n\n`;
            });

            // Create and download file
            const blob = new Blob([srtContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentFilename || 'video'}_translated.srt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatSRTTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')},${ms.toString().padStart(3, '0')}`;
        }

        // Demo data with improved timing for testing
        function loadDemoData() {
            const demoTranscript = `By the time you finish watching this video, 8 million cups of coffee will have been drunk all over the world. Coffee has been consumed for at least 1.5 thousand years, and some say its impact is so great that it helped fuel the enlightenment.`;
            
            const demoTranslation = `Para cuando termines de ver este video, se habrán bebido 8 millones de tazas de café en todo el mundo. El café se ha consumido durante al menos 1.5 mil años, y algunos dicen que su impacto es tan grande que ayudó a alimentar la iluminación.`;
            
            // Demo segments with precise timing for testing (20-second loop)
            const demoSegments = [
                { start: 0.0, end: 4.0, text: "Para cuando termines de ver este video," },
                { start: 4.0, end: 8.0, text: "se habrán bebido 8 millones de tazas de café" },
                { start: 8.0, end: 12.0, text: "en todo el mundo." },
                { start: 12.0, end: 16.0, text: "El café se consumió durante 1.5 mil años," },
                { start: 16.0, end: 20.0, text: "y ayudó a alimentar la iluminación." }
            ];
            
            console.log('Demo data loaded with segments:', demoSegments);
            return { transcript: demoTranscript, translation: demoTranslation, segments: demoSegments };
        }
    </script>
</body>
</html>